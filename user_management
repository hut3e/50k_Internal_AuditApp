import streamlit as st
import json
from datetime import datetime
from database_helper import get_supabase_client

def user_registration_interface():
    """Interface Ä‘Äƒng kÃ½ ngÆ°á»i dÃ¹ng má»›i"""
    st.title("ğŸ‘¥ ÄÄƒng kÃ½ ngÆ°á»i dÃ¹ng")
    
    # Tabs cho Ä‘Äƒng kÃ½ vÃ  quáº£n lÃ½
    tab1, tab2 = st.tabs(["ÄÄƒng kÃ½ má»›i", "Quáº£n lÃ½ ngÆ°á»i dÃ¹ng"])
    
    with tab1:
        register_new_user()
    
    with tab2:
        manage_users()

def register_new_user():
    """Form Ä‘Äƒng kÃ½ ngÆ°á»i dÃ¹ng má»›i"""
    st.subheader("ÄÄƒng kÃ½ ngÆ°á»i dÃ¹ng má»›i")
    
    with st.form("registration_form"):
        col1, col2 = st.columns(2)
        
        with col1:
            email = st.text_input("Email *", placeholder="user@example.com")
            full_name = st.text_input("Há» vÃ  tÃªn *", placeholder="Nguyá»…n VÄƒn A")
            role = st.selectbox("Vai trÃ² *", ["student", "teacher"])
            
        with col2:
            password = st.text_input("Máº­t kháº©u *", type="password", placeholder="Nháº­p máº­t kháº©u")
            class_name = st.text_input("Lá»›p/Khoa", placeholder="Lá»›p 12A1")
            phone = st.text_input("Sá»‘ Ä‘iá»‡n thoáº¡i", placeholder="0123456789")
        
        # ThÃªm cÃ¡c trÆ°á»ng bá»• sung
        student_id = st.text_input("MÃ£ há»c viÃªn/giáº£ng viÃªn", placeholder="SV001")
        address = st.text_area("Äá»‹a chá»‰", height=100)
        
        submitted = st.form_submit_button("ğŸ“ ÄÄƒng kÃ½", use_container_width=True)
        
        if submitted:
            # Validate dá»¯ liá»‡u
            if not email or not full_name or not password:
                st.error("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ cÃ¡c trÆ°á»ng báº¯t buá»™c (*)")
                return
                
            if not is_valid_email(email):
                st.error("Email khÃ´ng há»£p lá»‡")
                return
                
            if len(password) < 6:
                st.error("Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±")
                return
            
            # Táº¡o ngÆ°á»i dÃ¹ng má»›i
            success, message = create_new_user({
                "email": email,
                "full_name": full_name,
                "role": role,
                "password": password,
                "class": class_name,
                "phone": phone,
                "student_id": student_id,
                "address": address
            })
            
            if success:
                st.success(f"âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! {message}")
                st.balloons()
            else:
                st.error(f"âŒ ÄÄƒng kÃ½ tháº¥t báº¡i: {message}")

def manage_users():
    """Quáº£n lÃ½ ngÆ°á»i dÃ¹ng hiá»‡n cÃ³"""
    st.subheader("Quáº£n lÃ½ ngÆ°á»i dÃ¹ng")
    
    try:
        supabase = get_supabase_client()
        if not supabase:
            st.error("KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n database")
            return
            
        # Láº¥y danh sÃ¡ch ngÆ°á»i dÃ¹ng
        result = supabase.table("users").select("*").execute()
        users = result.data if result.data else []
        
        if not users:
            st.info("ChÆ°a cÃ³ ngÆ°á»i dÃ¹ng nÃ o trong há»‡ thá»‘ng")
            return
        
        # Bá»™ lá»c
        col1, col2 = st.columns(2)
        with col1:
            role_filter = st.selectbox("Lá»c theo vai trÃ²:", ["Táº¥t cáº£", "student", "teacher"])
        with col2:
            search_term = st.text_input("TÃ¬m kiáº¿m:", placeholder="Nháº­p tÃªn hoáº·c email")
        
        # Lá»c ngÆ°á»i dÃ¹ng
        filtered_users = users
        if role_filter != "Táº¥t cáº£":
            filtered_users = [u for u in filtered_users if u.get("role") == role_filter]
        
        if search_term:
            filtered_users = [u for u in filtered_users 
                            if search_term.lower() in u.get("full_name", "").lower() 
                            or search_term.lower() in u.get("email", "").lower()]
        
        # Hiá»ƒn thá»‹ danh sÃ¡ch
        st.write(f"**Tá»•ng sá»‘ ngÆ°á»i dÃ¹ng:** {len(filtered_users)}")
        
        for user in filtered_users:
            with st.expander(f"{'ğŸ‘¨â€ğŸ«' if user.get('role') == 'teacher' else 'ğŸ‘¨â€ğŸ“'} {user.get('full_name', '')} - {user.get('email', '')}"):
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write(f"**Email:** {user.get('email', '')}")
                    st.write(f"**Vai trÃ²:** {user.get('role', '')}")
                    st.write(f"**Lá»›p/Khoa:** {user.get('class', 'KhÃ´ng cÃ³')}")
                    
                with col2:
                    st.write(f"**MÃ£ sá»‘:** {user.get('student_id', 'KhÃ´ng cÃ³')}")
                    st.write(f"**Äiá»‡n thoáº¡i:** {user.get('phone', 'KhÃ´ng cÃ³')}")
                    reg_date = user.get('registration_date', '')
                    if reg_date:
                        try:
                            dt = datetime.fromisoformat(reg_date.replace("Z", "+00:00"))
                            formatted_date = dt.strftime("%d/%m/%Y")
                        except:
                            formatted_date = reg_date
                        st.write(f"**NgÃ y Ä‘Äƒng kÃ½:** {formatted_date}")
                
                if user.get('address'):
                    st.write(f"**Äá»‹a chá»‰:** {user.get('address')}")
                
                # NÃºt hÃ nh Ä‘á»™ng
                col1, col2 = st.columns(2)
                with col1:
                    if st.button(f"âœï¸ Sá»­a", key=f"edit_{user.get('email')}"):
                        st.session_state[f"editing_{user.get('email')}"] = True
                        
                with col2:
                    if st.button(f"ğŸ—‘ï¸ XÃ³a", key=f"delete_{user.get('email')}"):
                        if delete_user(user.get('email')):
                            st.success("ÄÃ£ xÃ³a ngÆ°á»i dÃ¹ng")
                            st.rerun()
                        else:
                            st.error("KhÃ´ng thá»ƒ xÃ³a ngÆ°á»i dÃ¹ng")
                
                # Form chá»‰nh sá»­a
                if st.session_state.get(f"editing_{user.get('email')}", False):
                    with st.form(f"edit_form_{user.get('email')}"):
                        st.write("**Chá»‰nh sá»­a thÃ´ng tin:**")
                        
                        new_name = st.text_input("Há» vÃ  tÃªn:", value=user.get('full_name', ''))
                        new_class = st.text_input("Lá»›p/Khoa:", value=user.get('class', ''))
                        new_phone = st.text_input("Äiá»‡n thoáº¡i:", value=user.get('phone', ''))
                        new_address = st.text_area("Äá»‹a chá»‰:", value=user.get('address', ''))
                        
                        col1, col2 = st.columns(2)
                        with col1:
                            if st.form_submit_button("ğŸ’¾ LÆ°u"):
                                if update_user(user.get('email'), {
                                    "full_name": new_name,
                                    "class": new_class,
                                    "phone": new_phone,
                                    "address": new_address
                                }):
                                    st.success("ÄÃ£ cáº­p nháº­t thÃ´ng tin")
                                    del st.session_state[f"editing_{user.get('email')}"]
                                    st.rerun()
                                else:
                                    st.error("KhÃ´ng thá»ƒ cáº­p nháº­t")
                        
                        with col2:
                            if st.form_submit_button("âŒ Há»§y"):
                                del st.session_state[f"editing_{user.get('email')}"]
                                st.rerun()
                                
    except Exception as e:
        st.error(f"CÃ³ lá»—i xáº£y ra: {str(e)}")

def create_new_user(user_data):
    """Táº¡o ngÆ°á»i dÃ¹ng má»›i trong database"""
    try:
        supabase = get_supabase_client()
        if not supabase:
            return False, "KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n database"
        
        # Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i
        existing_result = supabase.table("users").select("email").eq("email", user_data["email"]).execute()
        if existing_result.data:
            return False, "Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng"
        
        # ThÃªm thÃ´ng tin bá»• sung
        user_data["registration_date"] = datetime.now().isoformat()
        user_data["first_login"] = True
        
        # LÆ°u vÃ o database
        result = supabase.table("users").insert(user_data).execute()
        
        if result.data:
            return True, f"ÄÃ£ táº¡o tÃ i khoáº£n cho {user_data['full_name']}"
        else:
            return False, "KhÃ´ng thá»ƒ táº¡o tÃ i khoáº£n"
            
    except Exception as e:
        return False, f"Lá»—i: {str(e)}"

def update_user(email, updated_data):
    """Cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng"""
    try:
        supabase = get_supabase_client()
        if not supabase:
            return False
        
        result = supabase.table("users").update(updated_data).eq("email", email).execute()
        return True if result.data else False
        
    except Exception as e:
        print(f"Lá»—i khi cáº­p nháº­t ngÆ°á»i dÃ¹ng: {str(e)}")
        return False

def delete_user(email):
    """XÃ³a ngÆ°á»i dÃ¹ng"""
    try:
        supabase = get_supabase_client()
        if not supabase:
            return False
        
        result = supabase.table("users").delete().eq("email", email).execute()
        return True if result.data else False
        
    except Exception as e:
        print(f"Lá»—i khi xÃ³a ngÆ°á»i dÃ¹ng: {str(e)}")
        return False

def is_valid_email(email):
    """Kiá»ƒm tra Ä‘á»‹nh dáº¡ng email"""
    import re
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None
